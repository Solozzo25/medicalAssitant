<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Analysis Assistant</title>
    <!-- Include Tailwind CSS via CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* Additional custom styles */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="bg-blue-600 p-4 md:p-6">
            <h1 class="text-xl md:text-2xl font-bold text-white">Medical Analysis Assistant</h1>
            <p class="text-blue-100 mt-1">Input patient data to receive analysis</p>
        </div>
        
        <div class="p-4 md:p-6">
            <!-- Form View -->
            <div id="form-view" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Patient Age
                        </label>
                        <input
                            type="number"
                            id="age"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required
                            min="0"
                            max="120"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Biological Sex
                        </label>
                        <select
                            id="sex"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">Select sex</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Examination Results
                    </label>
                    <textarea
                        id="examResults"
                        rows="3"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter physical examination findings, vital signs, etc."
                        required
                    ></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Laboratory Results
                    </label>
                    <textarea
                        id="labResults"
                        rows="3"
                        class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter lab values, imaging results, etc."
                        required
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button
                        id="clear-btn"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        Clear
                    </button>
                    <button
                        id="submit-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        Get Analysis
                    </button>
                </div>
            </div>
            
            <!-- Results View (hidden by default) -->
            <div id="results-view" class="space-y-6 hidden">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h2 class="text-lg font-semibold text-blue-800 mb-2">Analysis Results</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Diagnosis</h3>
                            <p id="summary-text" class="mt-1 text-gray-800"></p>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Differential Diagnosis</h3>
                            <p id="risk-factors-text" class="mt-1 text-gray-800"></p>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Treatment Recommendations</h3>
                            <p id="recommendations-text" class="mt-1 text-gray-800"></p>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Pharmacotherapy</h3>
                            <p id="pharmacotherapy-text" class="mt-1 text-gray-800"></p>
                        </div>
                        
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">Further Steps</h3>
                            <p id="additional-tests-text" class="mt-1 text-gray-800"></p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button
                        id="new-patient-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        Enter New Patient Data
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>© 2025 Medical Analysis Assistant. For clinical decision support only.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM References
            const formView = document.getElementById('form-view');
            const resultsView = document.getElementById('results-view');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const newPatientBtn = document.getElementById('new-patient-btn');
            
            // Get form inputs
            const ageInput = document.getElementById('age');
            const sexSelect = document.getElementById('sex');
            const examResultsTextarea = document.getElementById('examResults');
            const labResultsTextarea = document.getElementById('labResults');
            
            // Get result text elements
            const summaryText = document.getElementById('summary-text');
            const recommendationsText = document.getElementById('recommendations-text');
            const pharmacotherapyText = document.getElementById('pharmacotherapy-text');
            const riskFactorsText = document.getElementById('risk-factors-text');
            const additionalTestsText = document.getElementById('additional-tests-text');
            
            // Event handlers
            submitBtn.addEventListener('click', handleSubmit);
            clearBtn.addEventListener('click', clearForm);
            newPatientBtn.addEventListener('click', showFormView);
            
            function handleSubmit() {
                // Form validation
                if (!validateForm()) {
                    return;
                }
                
                // Show loading state
                const originalButtonText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner"></div> Analyzing...';
                submitBtn.disabled = true;
                
                // Get form data
                const formData = {
                    age: ageInput.value,
                    sex: sexSelect.value,
                    examResults: examResultsTextarea.value,
                    labResults: labResultsTextarea.value
                };
                
                // Call Perplexity API
                analyzeData(formData)
                    .then(results => {
                        displayResults(results);
                        showResultsView();
                    })
                    .catch(error => {
                        alert('Error analyzing data: ' + error.message);
                        console.error(error);
                    })
                    .finally(() => {
                        // Reset button state
                        submitBtn.innerHTML = originalButtonText;
                        submitBtn.disabled = false;
                    });
            }
            
            function validateForm() {
                if (!ageInput.value) {
                    alert('Please enter patient age');
                    ageInput.focus();
                    return false;
                }
                
                if (!sexSelect.value) {
                    alert('Please select patient biological sex');
                    sexSelect.focus();
                    return false;
                }
                
                if (!examResultsTextarea.value) {
                    alert('Please enter examination results');
                    examResultsTextarea.focus();
                    return false;
                }
                
                if (!labResultsTextarea.value) {
                    alert('Please enter laboratory results');
                    labResultsTextarea.focus();
                    return false;
                }
                
                return true;
            }
            
            function clearForm() {
                ageInput.value = '';
                sexSelect.value = '';
                examResultsTextarea.value = '';
                labResultsTextarea.value = '';
            }
            
            function showFormView() {
                resultsView.classList.add('hidden');
                formView.classList.remove('hidden');
                clearForm();
            }
            
            function showResultsView() {
                formView.classList.add('hidden');
                resultsView.classList.remove('hidden');
                resultsView.classList.add('fade-in');
                setTimeout(() => {
                    resultsView.classList.remove('fade-in');
                }, 500);
            }
            
            function displayResults(results) {
                summaryText.textContent = results.diagnosis || "";
                riskFactorsText.textContent = results.differentialDiagnosis || "";
                recommendationsText.textContent = results.treatmentRecommendations || "";
                pharmacotherapyText.textContent = results.pharmacotherapy || "";
                additionalTestsText.textContent = results.furtherSteps || "";
            }
            
            // Function to create structured prompt for Perplexity
            function createPerplexityPrompt(patientData) {
                const { age, sex, examResults, labResults } = patientData;
                
                const prompt = `
Analiza medyczna dla pacjenta:
- Wiek: ${age}
- Płeć: ${sex}
- Wyniki badania: ${examResults}
- Wyniki laboratoryjne: ${labResults}

Proszę o przygotowanie analizy medycznej z wyraźnym podziałem na następujące sekcje:

1. DIAGNOZA GłÓWNA: Najbardziej prawdopodobna diagnoza na podstawie przedstawionych danych.

2. DIAGNOZA RÓŻNICOWA: Lista innych możliwych rozpoznań, które należy wziąć pod uwagę, uszeregowana według prawdopodobieństwa.

3. REKOMENDACJE LECZENIA: W zależności od ustalnej diagnozy głównej wyszukaj na stronie medycznego towarzystwa naukowego wytycznych dotyczących leczenia z podaniem konkretnych wytycznych (np. w przypadku chorób serca, kardiologicznego towarzystwa naukowego).

4. FARMAKOTERAPIA: Wyszukaj charakterystykę zalecanych leków oraz przedstaw wskazania oraz przeciwwskazania

5. DALSZE POSTĘPOWANIE: Bardzo krótko przedstaw sugestie dotyczące dodatkowych badań i konsultacji specjalistycznych.

Odpowiedź powinna być zwięzła, oparta na aktualnej wiedzy medycznej i zawierać odniesienia do aktualnych wytycznych.
`;

                return prompt;
            }
            
            // Function to call Perplexity API
            async function callPerplexityAPI(prompt) {
                try {
                    const options = {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer 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', // Replace with your actual API key
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "sonar-reasoning", // You can change to a different model if needed
                            messages: [
                                {
                                    role: "system",
                                    content: "Jesteś asystentem medycznym. Odpowiadaj w określonym formacie z wyraźnymi sekcjami. Bądź precyzyjny i zwięzły."
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ]
                        })
                    };

                    const response = await fetch('https://api.perplexity.ai/chat/completions', options);
                    
                    if (!response.ok) {
                        throw new Error('API response error: ' + response.status);
                    }
                    
                    const data = await response.json();
                    
                    // Typical Perplexity response structure contains a "choices" field
                    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                        return { text: data.choices[0].message.content };
                    } else {
                        throw new Error('Unexpected API response format');
                    }
                } catch (error) {
                    console.error('Error calling Perplexity API:', error);
                    throw error;
                }
            }
            
            // Helper function to extract sections from text
            function extractSection(text, startMarker, endMarker) {
                let startIndex = text.indexOf(startMarker);
                if (startIndex === -1) return "";
                
                startIndex += startMarker.length;
                
                let endIndex;
                if (endMarker) {
                    endIndex = text.indexOf(endMarker, startIndex);
                    if (endIndex === -1) endIndex = text.length;
                } else {
                    endIndex = text.length;
                }
                
                return text.substring(startIndex, endIndex).trim();
            }
            
            // Function to parse Perplexity response and split into sections
            function parsePerplexityResponse(responseData) {
                const fullText = responseData.text || "";
                
                // Attempt to split response into sections
                const sections = {
                    diagnosis: extractSection(fullText, "DIAGNOZA:", "DIAGNOZA RÓŻNICOWA:"),
                    differentialDiagnosis: extractSection(fullText, "DIAGNOZA RÓŻNICOWA:", "REKOMENDACJE LECZENIA:"),
                    treatmentRecommendations: extractSection(fullText, "REKOMENDACJE LECZENIA:", "FARMAKOTERAPIA:"),
                    pharmacotherapy: extractSection(fullText, "FARMAKOTERAPIA:", "DALSZE POSTĘPOWANIE:"),
                    furtherSteps: extractSection(fullText, "DALSZE POSTĘPOWANIE:", null)
                };
                
                return sections;
            }
            
            // Main function to analyze patient data
            async function analyzeData(patientData) {
                try {
                    // FOR TESTING: Return mock data instead of calling the API
                    // Remove this block when you're ready to use the real API
                    if (false) { // Change to false to use real API
                        return {
                            diagnosis: "Na podstawie przedstawionych danych, najbardziej prawdopodobna diagnoza to nadciśnienie tętnicze stopnia 1 z hipercholesterolemią.",
                            differentialDiagnosis: "1. Nadciśnienie wtórne\n2. Izolowana hipercholesterolemia\n3. Zespół metaboliczny\n4. Stres sytuacyjny (nadciśnienie białego fartucha)",
                            treatmentRecommendations: "Zgodnie z wytycznymi ESC/ESH 2023, w przypadku nadciśnienia stopnia 1 z umiarkowanym ryzykiem sercowo-naczyniowym zalecane są:\n1. Modyfikacja stylu życia (dieta DASH, redukcja spożycia soli, aktywność fizyczna 150 min/tydz)\n2. Farmakoterapia, jeśli modyfikacje stylu życia są nieskuteczne po 3-6 miesiącach",
                            pharmacotherapy: "Zalecane leki pierwszego rzutu:\n1. Inhibitory ACE (np. Ramipril 5-10mg 1x dziennie) - działania niepożądane: kaszel, hiperkaliemia\n2. Statyny (np. Atorwastatyna 10-20mg wieczorem) - działania niepożądane: bóle mięśniowe, wzrost enzymów wątrobowych",
                            furtherSteps: "1. EKG spoczynkowe\n2. Badanie dna oka\n3. Kontrola lipidogramu po 3 miesiącach\n4. Zalecany ABPM (24-godzinny pomiar ciśnienia tętniczego)"
                        };
                    }
                    
                    // 1. Create prompt
                    const prompt = createPerplexityPrompt(patientData);
                    
                    // 2. Call Perplexity API
                    const apiResponse = await callPerplexityAPI(prompt);
                    
                    // 3. Process response
                    const parsedSections = parsePerplexityResponse(apiResponse);
                    
                    // 4. Return data for display
                    return parsedSections;
                } catch (error) {
                    console.error("Error analyzing data:", error);
                    throw error;
                }
            }
        });
    </script>
</body>
</html>
